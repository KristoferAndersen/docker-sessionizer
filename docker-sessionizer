#!/bin/bash
set -e

dotfiles_path="$HOME/dev/dots"

image_name="dev-session"
container_prefix="dev"
search_dirs=("$HOME/dev" "$HOME/git" "$HOME/personal")

# Usage
if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(find "${search_dirs[@]}" -mindepth 1 -maxdepth 1 -type d | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

project_path=$(realpath "$selected")
project_name=$(basename "$project_path" | tr . _)
container_name="${container_prefix}-${project_name}"
session_name="${container_name}"

# Build image if it doesn't exist
if ! docker image inspect "$image_name" &>/dev/null; then
    echo "Building dev image..."
    docker build -t "$image_name" "$(dirname "$(realpath "$0")")"
fi

# Start container if not running
if ! docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
    docker rm "$container_name" &>/dev/null || true

    docker run -d \
        --name "$container_name" \
        -v "$project_path:/workspace" \
        -v "$dotfiles_path:/home/dev/dotfiles" \
        -v "${container_name}-cache:/home/dev/.cache" \
        "$image_name" \
        sleep infinity
fi

# Create or switch to tmux session with docker exec as default command
if ! tmux has-session -t "$session_name"; then
    tmux new-session -d -s "$session_name" \
        "docker exec -it -w /workspace $container_name /bin/bash"
    tmux set-option -t "$session_name" default-command \
        "docker exec -it -w /workspace $container_name /bin/bash"
fi

# Attach or switch
if [[ -z "$TMUX" ]]; then
    tmux attach-session -t "$session_name"
else
    tmux switch-client -t "$session_name"
fi
