#!/bin/bash
set -e

IMAGE_NAME="dev-session"
CONTAINER_PREFIX="dev"
DOTFILES_PATH="$HOME/dev/dots"

# Usage
if [[ $# -lt 1 ]]; then
    echo "Usage: docker-sessionizer <project-path>"
    exit 1
fi

PROJECT_PATH=$(realpath "$1")
PROJECT_NAME=$(basename "$PROJECT_PATH" | tr . _)
CONTAINER_NAME="${CONTAINER_PREFIX}-${PROJECT_NAME}"
SESSION_NAME="${CONTAINER_NAME}"

# Build image if it doesn't exist
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Building dev image..."
    docker build -t "$IMAGE_NAME" "$(dirname "$(realpath "$0")")"
fi

# Start container if not running
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    docker rm "$CONTAINER_NAME" &>/dev/null || true

    docker run -d \
        --name "$CONTAINER_NAME" \
        -v "$PROJECT_PATH:/workspace" \
        -v "$DOTFILES_PATH:/home/dev/dotfiles" \
        -v "${CONTAINER_NAME}-cache:/home/dev/.cache" \
        "$IMAGE_NAME" \
        sleep infinity
fi

# Create or switch to tmux session with docker exec as default command
if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    tmux new-session -d -s "$SESSION_NAME" \
        "docker exec -it -w /workspace $CONTAINER_NAME /bin/zsh"
    tmux set-option -t "$SESSION_NAME" default-command \
        "docker exec -it -w /workspace $CONTAINER_NAME /bin/zsh"
fi

# Attach or switch
if [[ -z "$TMUX" ]]; then
    tmux attach-session -t "$SESSION_NAME"
else
    tmux switch-client -t "$SESSION_NAME"
fi
